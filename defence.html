<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>방어폭 계산 (최소 UI)</title>
  <style>
    :root { --gap: 6px; --pad: 10px; --radius: 10px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    * { box-sizing: border-box; }
    body { font-family: var(--font); background: #0b0d12; color: #e6e6e6; margin: 0; padding: 24px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 16px; font-weight: 700; }
    .note { font-size: 13px; color: #cfcfcf; margin-bottom: 12px; }
    .warn { color: #ffd166; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: var(--radius); background: #121521; }
    thead th { position: sticky; top: 0; background: #161a2a; }
    th, td { padding: 10px 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.06); }
    tbody tr:hover td { background: rgba(255,255,255,0.02); }
    tfoot td { background: #161a2a; border-top: 1px solid rgba(255,255,255,0.08); }
    input[type="number"] { width: 100%; background: #0f1320; border: 1px solid rgba(255,255,255,0.08); color: #e6e6e6; padding: 8px; border-radius: 8px; text-align: right; }
    input[readonly] { opacity: 0.85; background: #0d111a; }
    .row-sl { background: #1a2035; font-weight: 700; }
    .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0 18px; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #1a2035; font-size: 12px; }
    .error { font-size: 13px; color: #ff6b6b; margin-top: 8px; min-height: 1.2em; }
    .small { font-size: 12px; color: #9aa4b2; }
    .footer { display:flex; justify-content: space-between; align-items: center; margin-top: 14px; gap: 10px; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: #141a2a; color: #e6e6e6; cursor: pointer; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .muted { opacity: .75; }
    @media (max-width: 700px) {
      .meta { grid-template-columns: 1fr; }
      th, td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>방어폭 계산 (입·출력 전용 UI)</h1>
    <div class="note"><span class="badge">주의</span> <span class="warn">∇% 열은 항상 이전 행보다 크거나 같아야 합니다.</span></div>

    <div class="meta">
      <div class="small">※ 이 화면은 사용자 입력과 결과 표시만 포함합니다. 계산 로직과 기타 데이터는 백엔드에 위치합니다.</div>
      <div class="small" style="text-align:right;">필드 단위: DCA Size(수량/금액), ∇%(하락폭), Leverage(배율)</div>
    </div>

    <table id="dca-table" aria-describedby="monotone-note">
      <thead>
        <tr>
          <th>NO</th>
          <th>DCA Size</th>
          <th>∇%</th>
          <th></th>
          <th>Leverage</th>
          <th>방어폭 결과값</th>
          <th>예상손절금액</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows 0 ~ 20 -->
      </tbody>
      <tfoot>
        <tr class="row-sl">
          <td>SL</td>
          <td></td>
          <td><input type="number" inputmode="decimal" step="0.01" id="sl-delta" placeholder="120" /></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td colspan="7">
            <div class="footer">
              <div class="small muted">행 추가 개수는 0~20으로 고정되어 있습니다.</div>
              <div>
                <button class="btn" id="btn-submit">저장/계산 요청</button>
              </div>
            </div>
            <div id="error" class="error" aria-live="polite"></div>
          </td>
        </tr>
      </tfoot>
    </table>

    <div class="meta" style="margin-top:18px;">
      <div class="small"><strong>변하는셀</strong></div>
      <div class="small"><strong>결과셀</strong></div>
    </div>
  </div>

<script>
(function(){
  const tbody = document.querySelector('#dca-table tbody');
  const errorBox = document.getElementById('error');
  const btnSubmit = document.getElementById('btn-submit');

  // Initial seed values based on the user's example for row 0~3
  const seed = [
    { no: 0, dca: 80,  delta: '', lev: 20, res: 10.5, stop: 38.4 },
    { no: 1, dca: 80,  delta: 30, lev: '', res: '',   stop: ''   },
    { no: 2, dca: 160, delta: 60, lev: '', res: '',   stop: ''   },
    { no: 3, dca: 320, delta: 90, lev: '', res: '',   stop: ''   }
  ];

  function makeRow(i, preset) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i}</td>
      <td><input type="number" inputmode="decimal" step="0.0001" name="dca_${i}" value="${preset?.dca ?? ''}" /></td>
      <td><input type="number" inputmode="decimal" step="0.01" name="delta_${i}" value="${preset?.delta ?? ''}" /></td>
      <td></td>
      <td><input type="number" inputmode="decimal" step="0.01" name="lev_${i}" value="${preset?.lev ?? ''}" /></td>
      <td><input type="number" inputmode="decimal" step="0.0001" name="res_${i}" value="${preset?.res ?? ''}" readonly /></td>
      <td><input type="number" inputmode="decimal" step="0.0001" name="stop_${i}" value="${preset?.stop ?? ''}" readonly /></td>
    `;
    return tr;
  }

  // Build 0..20 rows
  for (let i = 0; i <= 20; i++) {
    tbody.appendChild(makeRow(i, seed.find(s => s.no === i)));
  }

  function validateMonotone() {
    const deltas = [];
    for (let i = 0; i <= 20; i++) {
      const el = document.querySelector(`input[name="delta_${i}"]`);
      const val = el && el.value !== '' ? Number(el.value) : null;
      deltas.push(val);
    }
    // Check non-decreasing: delta[i] >= delta[i-1] for all defined values
    for (let i = 1; i < deltas.length; i++) {
      if (deltas[i] != null && deltas[i-1] != null && deltas[i] < deltas[i-1]) {
        return { ok: false, index: i };
      }
    }
    return { ok: true };
  }

  function showError(msg) { errorBox.textContent = msg || ''; }
  function clearError() { showError(''); }

  // Live validation
  tbody.addEventListener('input', (e) => {
    if (e.target && e.target.name && e.target.name.startsWith('delta_')) {
      const check = validateMonotone();
      if (!check.ok) {
        showError(`∇%는 이전 행보다 작을 수 없습니다. (행 ${check.index})`);
      } else {
        clearError();
      }
    }
  });

  // Submit handler (placeholder that posts only user-entered values; backend handles computation)
  btnSubmit.addEventListener('click', async () => {
    const payload = { rows: [], sl_delta: null };
    for (let i = 0; i <= 20; i++) {
      const dca = document.querySelector(`input[name="dca_${i}"]`)?.value;
      const delta = document.querySelector(`input[name="delta_${i}"]`)?.value;
      const lev = document.querySelector(`input[name="lev_${i}"]`)?.value;
      const res = document.querySelector(`input[name="res_${i}"]`)?.value;
      const stop = document.querySelector(`input[name="stop_${i}"]`)?.value;
      payload.rows.push({
        no: i,
        dca: dca === '' ? null : Number(dca),
        delta: delta === '' ? null : Number(delta),
        lev: lev === '' ? null : Number(lev),
        res: res === '' ? null : Number(res),        // read-only placeholders to display server results
        stop: stop === '' ? null : Number(stop)      // read-only placeholders to display server results
      });
    }
    const sl = document.getElementById('sl-delta').value;
    payload.sl_delta = sl === '' ? null : Number(sl);

    const check = validateMonotone();
    if (!check.ok) {
      showError(`∇%는 이전 행보다 작을 수 없습니다. (행 ${check.index})`);
      return;
    }
    clearError();

    // --- Backend wiring placeholder ---
    // Replace with your endpoint, then populate the read-only result cells from the response.
    // Example:
    // const res = await fetch('/api/dca/compute', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    // const data = await res.json(); // { rows: [ { res, stop } ... ] }
    // data.rows.forEach((row, i) => {
    //   if (row && typeof row.res === 'number') document.querySelector(`input[name="res_${i}"]`).value = row.res;
    //   if (row && typeof row.stop === 'number') document.querySelector(`input[name="stop_${i}"]`).value = row.stop;
    // });
    // ----------------------------------

    // Temporary local echo just to show the payload in console for developers.
    console.log('POST payload (send to backend):', payload);
    showError('전송 준비 완료. 백엔드 엔드포인트에 연결하면 결과셀이 자동으로 채워집니다.');
  });
})();
</script>
</body>
</html>
