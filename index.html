<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∞©Ïñ¥Ìè≠ Í≥ÑÏÇ∞Í∏∞ (Long/Short Íµ¨Î∂Ñ)</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-gray-400-rgb: 119, 124, 124;
            
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-charcoal-700);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-input-bg: rgba(255, 255, 200, 0.3);
            --color-output-bg: rgba(200, 180, 255, 0.2);
            
            --font-family-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
            --radius-base: 8px;
            --radius-lg: 12px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-300);
                --color-text-secondary: rgba(var(--color-gray-300), 0.7);
                --color-primary: var(--color-teal-300);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-input-bg: rgba(255, 255, 100, 0.15);
                --color-output-bg: rgba(180, 160, 255, 0.15);
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: var(--space-24);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: var(--space-24);
            color: var(--color-text);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-24);
            margin-bottom: var(--space-24);
        }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: var(--space-16);
            font-size: 1.25rem;
            color: var(--color-text);
        }

        .input-section {
            background: var(--color-input-bg);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .output-section {
            background: var(--color-output-bg);
            padding: var(--space-16);
            border-radius: var(--radius-base);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: 500;
            color: var(--color-text);
        }

        input[type="number"] {
            width: 100%;
            padding: var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 1rem;
            background: var(--color-surface);
            color: var(--color-text);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .btn {
            width: 100%;
            padding: var(--space-12) var(--space-16);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-base);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-hover);
        }

        .result-grid {
            display: grid;
            gap: var(--space-12);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-12);
            background: var(--color-surface);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
        }

        .result-label {
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .result-value {
            font-weight: 600;
            color: var(--color-text);
            font-size: 1.1rem;
        }

        .dca-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-16);
        }

        .dca-table th,
        .dca-table td {
            padding: var(--space-8);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .dca-table th {
            background: var(--color-input-bg);
            font-weight: 600;
        }

        .dca-table input {
            width: 100%;
            padding: var(--space-8);
        }

        .add-dca-btn {
            width: 100%;
            padding: var(--space-12) var(--space-16);
            margin-bottom: var(--space-16);
            background: var(--color-primary);
            color: white;
            font-weight: 500;
        }

        .add-dca-btn:hover {
            background: var(--color-primary-hover);
        }

        .remove-btn {
            padding: var(--space-8);
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .remove-btn:hover {
            background: #cc0000;
        }

        .scale-settings {
            background: var(--color-input-bg);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .scale-params {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-12);
            margin-bottom: var(--space-16);
        }

        .param-item {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .param-item label {
            font-weight: 600;
            margin: 0;
            min-width: 20px;
        }

        .param-item input {
            flex: 1;
            padding: var(--space-8);
        }

        .scale-controls {
            display: flex;
            flex-direction: column;
            gap: var(--space-12);
        }

        .scale-row {
            display: flex;
            align-items: center;
            gap: var(--space-12);
        }

        .scale-row label {
            min-width: 100px;
            margin: 0;
            font-weight: 500;
        }

        .scale-btn {
            padding: var(--space-8) var(--space-16);
            background: var(--color-surface);
            color: var(--color-text);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            min-width: 80px;
        }

        .scale-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .scale-btn:not(:disabled):hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .scale-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 0 15px rgba(var(--color-teal-500-rgb), 0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Î∞©Ïñ¥Ìè≠ Í≥ÑÏÇ∞Í∏∞ (Long/Short Íµ¨Î∂Ñ)</h1>
        
        <div class="calculator-grid">
            <!-- Input Section -->
            <div class="card">
                <h2>üìä Í∏∞Î≥∏ ÏÑ§Ï†ï</h2>
                <div class="input-section">
                    <div class="form-group">
                        <label for="initialSize">DCA Size (Ï¥àÍ∏∞ ÏÇ¨Ïù¥Ï¶à)</label>
                        <input type="number" id="initialSize" value="10" step="1" min="0" onkeydown="preventNegative(event)" oninput="syncInitialSize()">
                    </div>
                    <div class="form-group">
                        <label for="initialProfit">Profit % (Ï¥àÍ∏∞ ÏùµÏ†à %)</label>
                        <input type="number" id="initialProfit" value="5" step="0.1" min="0" onkeydown="preventNegative(event)" oninput="syncInitialProfit()">
                    </div>
                    <div class="form-group">
                        <label for="leverage">Leverage (Î†àÎ≤ÑÎ¶¨ÏßÄ)</label>
                        <input type="number" id="leverage" value="20" step="1" min="1" onkeydown="preventNegative(event)">
                    </div>
                    <div class="form-group">
                        <label for="stopLoss">SL (ÏÜêÏ†à %)</label>
                        <input type="number" id="stopLoss" value="700" step="10" min="0" onkeydown="preventNegative(event)">
                    </div>
                </div>

                <h2>üéõÔ∏è Ïä§ÏºÄÏùº ÏÑ§Ï†ï</h2>
                <div class="scale-settings">
                    <div class="scale-params">
                        <div class="param-item">
                            <label>n:</label>
                            <input type="number" id="param-n" value="0" step="0.1" min="0" onkeydown="preventNegative(event)" oninput="updateScaleButtons()">
                        </div>
                        <div class="param-item">
                            <label>m:</label>
                            <input type="number" id="param-m" value="0" step="0.1" min="0" onkeydown="preventNegative(event)" oninput="updateScaleButtons()">
                        </div>
                        <div class="param-item">
                            <label>l:</label>
                            <input type="number" id="param-l" value="0" step="0.1" min="0" onkeydown="preventNegative(event)" oninput="updateScaleButtons()">
                        </div>
                        <div class="param-item">
                            <label>a:</label>
                            <input type="number" id="param-a" value="0" step="1" min="0" onkeydown="preventNegative(event)" oninput="updateScaleButtons()">
                        </div>
                        <div class="param-item">
                            <label>b:</label>
                            <input type="number" id="param-b" value="0" step="1" min="0" onkeydown="preventNegative(event)" oninput="updateScaleButtons()">
                        </div>
                        <div class="param-item">
                            <label>c:</label>
                            <input type="number" id="param-c" value="0" step="1" min="0" onkeydown="preventNegative(event)" oninput="updateScaleButtons()">
                        </div>
                    </div>
                    
                    <div class="scale-controls">
                        <div class="scale-row">
                            <label>DCA scale:</label>
                            <button class="scale-btn" id="btn-xn" onclick="toggleScale('dca', 'multiply', 'n')" disabled>√ó n</button>
                            <button class="scale-btn" id="btn-plus-a" onclick="toggleScale('dca', 'add', 'a')" disabled>+ a</button>
                        </div>
                        <div class="scale-row">
                            <label>ROI scale:</label>
                            <button class="scale-btn" id="btn-xm" onclick="toggleScale('roi', 'multiply', 'm')" disabled>√ó m</button>
                            <button class="scale-btn" id="btn-plus-b" onclick="toggleScale('roi', 'add', 'b')" disabled>+ b</button>
                        </div>
                        <div class="scale-row">
                            <label>Profit scale:</label>
                            <button class="scale-btn" id="btn-xl" onclick="toggleScale('profit', 'multiply', 'l')" disabled>√ó l</button>
                            <button class="scale-btn" id="btn-plus-c" onclick="toggleScale('profit', 'add', 'c')" disabled>+ c</button>
                        </div>
                    </div>
                </div>

                <h2>üìà DCA Îã®Í≥Ñ ÏÑ§Ï†ï</h2>
                <button class="btn add-dca-btn" onclick="addDcaStep()">+ DCA Îã®Í≥Ñ Ï∂îÍ∞Ä</button>
                <button class="btn" onclick="showTextInput()" style="margin-bottom: var(--space-16); background: var(--color-text-secondary);">Î°úÏßÅ ÌÖçÏä§Ìä∏ ÏûÖÎ†•</button>
                
                <div id="textInputModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: var(--color-surface); padding: var(--space-24); border-radius: var(--radius-lg); max-width: 500px; width: 90%;">
                        <h3>DCA Î°úÏßÅ ÌÖçÏä§Ìä∏ ÏûÖÎ†•</h3>
                        <p style="font-size: 0.9rem; color: var(--color-text-secondary);">ÌòïÏãù: DCA Size, Profit %, Î≥ÄÎèôÎ•† (Ìïú Ï§ÑÏóê ÌïòÎÇòÏî©)</p>
                        <textarea id="logicTextInput" style="width: 100%; height: 200px; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); font-family: monospace; background: var(--color-surface); color: var(--color-text);" placeholder="ÏòàÏãú:&#10;10,20,45&#10;10,25,100&#10;10,30,200&#10;10,35,300"></textarea>
                        <div style="display: flex; gap: var(--space-12); margin-top: var(--space-16);">
                            <button class="btn" onclick="applyTextLogic()" style="flex: 1;">Ï†ÅÏö©</button>
                            <button class="btn" onclick="closeTextInput()" style="flex: 1; background: var(--color-text-secondary);">Ï∑®ÏÜå</button>
                        </div>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="dca-table">
                        <thead>
                            <tr>
                                <th>Îã®Í≥Ñ</th>
                                <th>DCA Size</th>
                                <th>Profit %</th>
                                <th>‚àá% (Î≥ÄÎèôÎ•†)</th>
                                <th>ÏòàÏÉÅ ÏùµÏ†àÍ∏à</th>
                                <th>ÏÇ≠Ï†ú</th>
                            </tr>
                        </thead>
                        <tbody id="dcaSteps">
                            <!-- DCA steps will be added here dynamically -->
                        </tbody>
                    </table>
                </div>

                <button class="btn" onclick="calculate()">Í≥ÑÏÇ∞ÌïòÍ∏∞</button>
            </div>

            <!-- Output Section -->
            <div class="card">
                <h2>üìã Í≥ÑÏÇ∞ Í≤∞Í≥º</h2>
                <div class="output-section">
                    <div class="result-grid">
                        <div class="result-item">
                            <span class="result-label">ROI Î∞©Ïñ¥Ìè≠ Í≤∞Í≥ºÍ∞í</span>
                            <span class="result-value" id="resultTotal">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ÌòÑÎ¨º L Î∞©Ïñ¥Ìè≠</span>
                            <span class="result-value" id="resultLong">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ÌòÑÎ¨º S Î∞©Ïñ¥Ìè≠</span>
                            <span class="result-value" id="resultShort">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ÏòàÏÉÅ ÏÜêÏ†à Í∏àÏï°</span>
                            <span class="result-value" id="expectedLoss">-</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: var(--space-24);">
                    <h3>üí° Í≥ÑÏÇ∞ ÏÑ§Î™Ö</h3>
                    <ul style="font-size: 0.9rem; color: var(--color-text-secondary);">
                        <li><strong>ROI Î∞©Ïñ¥Ìè≠ Í≤∞Í≥ºÍ∞í:</strong> Ï†ÑÏ≤¥ ÎàÑÏ†Å Î≥ÄÎèôÎ•† / Î†àÎ≤ÑÎ¶¨ÏßÄ</li>
                        <li><strong>ÌòÑÎ¨º L Î∞©Ïñ¥Ìè≠:</strong> Long Ìè¨ÏßÄÏÖòÏùò Ï≤´ ÏßÑÏûÖÏãúÏùò ÏßÑÏûÖÍ∞Ä ÎåÄÎπÑ ÌòÑÎ¨º Î∞©Ïñ¥Ìè≠ %</li>
                        <li><strong>ÌòÑÎ¨º S Î∞©Ïñ¥Ìè≠:</strong> Short Ìè¨ÏßÄÏÖòÏùò Ï≤´ ÏßÑÏûÖÏãúÏùò ÏßÑÏûÖÍ∞Ä ÎåÄÎπÑ ÌòÑÎ¨º Î∞©Ïñ¥Ìè≠ %</li>
                        <li><strong>ÏòàÏÉÅ ÏÜêÏ†à Í∏àÏï°:</strong> (Ï¥ù ÎßàÏßÑ √ó SL%) / 100</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Scale state management
        let activeScales = {
            dca: { type: null, param: null },
            roi: { type: null, param: null },
            profit: { type: null, param: null }
        };

        function updateScaleButtons() {
            const params = {
                n: parseFloat(document.getElementById('param-n').value) || 0,
                a: parseFloat(document.getElementById('param-a').value) || 0,
                m: parseFloat(document.getElementById('param-m').value) || 0,
                b: parseFloat(document.getElementById('param-b').value) || 0,
                l: parseFloat(document.getElementById('param-l').value) || 0,
                c: parseFloat(document.getElementById('param-c').value) || 0
            };

            document.getElementById('btn-xn').disabled = params.n === 0;
            document.getElementById('btn-plus-a').disabled = params.a === 0;
            document.getElementById('btn-xm').disabled = params.m === 0;
            document.getElementById('btn-plus-b').disabled = params.b === 0;
            document.getElementById('btn-xl').disabled = params.l === 0;
            document.getElementById('btn-plus-c').disabled = params.c === 0;
        }

        function toggleScale(category, type, param) {
            const btnId = `btn-${type === 'multiply' ? 'x' : 'plus-'}${param}`;
            const btn = document.getElementById(btnId);
            
            if (activeScales[category].type === type && activeScales[category].param === param) {
                activeScales[category] = { type: null, param: null };
                btn.classList.remove('active');
            } else {
                const allBtns = document.querySelectorAll('.scale-btn');
                allBtns.forEach(b => {
                    if (b.id.includes(category === 'dca' ? 'xn' : category === 'roi' ? 'xm' : 'xl') || 
                        b.id.includes(category === 'dca' ? 'plus-a' : category === 'roi' ? 'plus-b' : 'plus-c')) {
                        b.classList.remove('active');
                    }
                });
                
                activeScales[category] = { type, param };
                btn.classList.add('active');
            }
        }

        function getScaledValue(category, lastValue) {
            const scale = activeScales[category];
            if (!scale.type || !scale.param) return lastValue;

            const paramValue = parseFloat(document.getElementById(`param-${scale.param}`).value) || 1;
            
            if (scale.type === 'multiply') {
                return lastValue * paramValue;
            } else if (scale.type === 'add') {
                return lastValue + paramValue;
            }
            
            return lastValue;
        }

        function initializeDcaSteps() {
            addDcaStepWithValues(10, 0, 5, true);
            
            const defaultSteps = [
                { size: 10, changePercent: 30 },
                { size: 10, changePercent: 60 },
                { size: 10, changePercent: 90 },
                { size: 10, changePercent: 130 },
                { size: 10, changePercent: 180 },
                { size: 10, changePercent: 240 },
                { size: 10, changePercent: 320 },
                { size: 10, changePercent: 400 }
            ];

            defaultSteps.forEach(step => {
                addDcaStepWithValues(step.size, step.changePercent, 5, false);
            });
        }

        function addDcaStep() {
            const tbody = document.getElementById('dcaSteps');
            const rows = tbody.rows;
            
            let lastSize = 10;
            let lastChange = 0;
            let lastProfit = 5;
            
            if (rows.length > 1) {
                const lastRow = rows[rows.length - 1];
                lastSize = parseFloat(lastRow.querySelector('.dca-size').value) || 10;
                const lastChangeInput = lastRow.querySelector('.dca-change');
                lastChange = lastChangeInput ? parseFloat(lastChangeInput.value) || 0 : 0;
                lastProfit = parseFloat(lastRow.querySelector('.dca-profit').value) || 5;
            }
            
            const newSize = getScaledValue('dca', lastSize);
            const newChange = getScaledValue('roi', lastChange);
            const newProfit = getScaledValue('profit', lastProfit);
            
            addDcaStepWithValues(newSize, newChange, newProfit, false);
        }

        function addDcaStepWithValues(size, changePercent, profit = 5, isInitial = false) {
            const tbody = document.getElementById('dcaSteps');
            const rowCount = tbody.rows.length;
            const row = tbody.insertRow();
            
            const stepNumber = rowCount;
            const changeTd = isInitial 
                ? '<td style="background: var(--color-border); text-align: center;">-</td>'
                : `<td><input type="number" class="dca-change" value="${changePercent}" step="1" min="0" data-row="${rowCount}" data-col="2" onfocus="this.select()" onkeydown="preventNegative(event); handleArrowKeys(event, this)"></td>`;
            
            const deleteBtn = isInitial
                ? '<td></td>'
                : '<td><button class="remove-btn" onclick="removeDcaStep(this)">ÏÇ≠Ï†ú</button></td>';
            
            const sizeInput = isInitial
                ? `<input type="number" class="dca-size initial-size" value="${size}" step="1" min="0" data-row="${rowCount}" data-col="0" onfocus="this.select()" onkeydown="preventNegative(event); handleArrowKeys(event, this)" oninput="syncFromTable()">`
                : `<input type="number" class="dca-size" value="${size}" step="1" min="0" data-row="${rowCount}" data-col="0" onfocus="this.select()" onkeydown="preventNegative(event); handleArrowKeys(event, this)" onchange="calculateProfitValues()">`;
            
            const profitInput = isInitial
                ? `<input type="number" class="dca-profit initial-profit" value="${profit}" step="0.1" min="0" data-row="${rowCount}" data-col="1" onfocus="this.select()" onkeydown="preventNegative(event); handleArrowKeys(event, this)" oninput="syncFromTable()">`
                : `<input type="number" class="dca-profit" value="${profit}" step="0.1" min="0" data-row="${rowCount}" data-col="1" onfocus="this.select()" onkeydown="preventNegative(event); handleArrowKeys(event, this)" onchange="calculateProfitValues()">`;
            
            row.innerHTML = `
                <td>${stepNumber}</td>
                <td>${sizeInput}</td>
                <td>${profitInput}</td>
                ${changeTd}
                <td class="expected-profit">-</td>
                ${deleteBtn}
            `;
        }

        function removeDcaStep(btn) {
            const row = btn.closest('tr');
            row.remove();
            updateStepNumbers();
        }

        function updateStepNumbers() {
            const tbody = document.getElementById('dcaSteps');
            Array.from(tbody.rows).forEach((row, index) => {
                row.cells[0].textContent = index;
            });
        }

        function preventNegative(event) {
            if (event.key === '-' || event.key === 'e' || event.key === 'E') {
                event.preventDefault();
            }
        }

        function syncInitialSize() {
            const initialSize = document.getElementById('initialSize').value;
            const firstRowSizeInput = document.querySelector('.initial-size');
            if (firstRowSizeInput) {
                firstRowSizeInput.value = initialSize;
                calculateProfitValues();
            }
        }

        function syncInitialProfit() {
            const initialProfit = document.getElementById('initialProfit').value;
            const firstRowProfitInput = document.querySelector('.initial-profit');
            if (firstRowProfitInput) {
                firstRowProfitInput.value = initialProfit;
                calculateProfitValues();
            }
        }

        function syncFromTable() {
            const firstRowSizeInput = document.querySelector('.initial-size');
            const firstRowProfitInput = document.querySelector('.initial-profit');
            
            if (firstRowSizeInput) {
                document.getElementById('initialSize').value = firstRowSizeInput.value;
            }
            if (firstRowProfitInput) {
                document.getElementById('initialProfit').value = firstRowProfitInput.value;
            }
            calculateProfitValues();
        }

        function calculateProfitValues() {
            const leverage = parseFloat(document.getElementById('leverage').value) || 1;
            const rows = document.getElementById('dcaSteps').rows;
            
            let cumulativeSize = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const sizeInput = rows[i].querySelector('.dca-size');
                const profitInput = rows[i].querySelector('.dca-profit');
                const expectedProfitCell = rows[i].querySelector('.expected-profit');
                
                const size = parseFloat(sizeInput.value) || 0;
                const profit = parseFloat(profitInput.value) || 0;
                
                cumulativeSize += size;
                
                const expectedProfit = (cumulativeSize / leverage) * (profit / 100);
                expectedProfitCell.textContent = expectedProfit.toFixed(3);
            }
        }

        function calculate() {
            const leverage = parseFloat(document.getElementById('leverage').value) || 1;
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;

            calculateProfitValues();

            const dcaSizes = [];
            const changePercents = [];
            
            const rows = document.getElementById('dcaSteps').rows;
            for (let i = 0; i < rows.length; i++) {
                const sizeInput = rows[i].querySelector('.dca-size');
                const changeInput = rows[i].querySelector('.dca-change');
                
                dcaSizes.push(parseFloat(sizeInput.value) || 0);
                
                if (changeInput) {
                    changePercents.push(parseFloat(changeInput.value) || 0);
                } else {
                    changePercents.push(0);
                }
            }

            const results = calculateDefenseRange(dcaSizes, changePercents, leverage, stopLoss);

            document.getElementById('resultTotal').textContent = results.totalDefense.toFixed(2) + '%';
            document.getElementById('resultLong').textContent = results.longDefense.toFixed(2) + '%';
            document.getElementById('resultShort').textContent = results.shortDefense.toFixed(2) + '%';
            document.getElementById('expectedLoss').textContent = results.expectedLoss.toFixed(2);
        }

        function calculateDefenseRange(sizes, changePercents, leverage, stopLoss) {
            const n = sizes.length;
            
            const cumulativeSizes = [];
            let sum = 0;
            for (let i = 0; i < n; i++) {
                sum += sizes[i];
                cumulativeSizes.push(sum);
            }

            const dcaRoi = [0];
            
            for (let i = 1; i < n; i++) {
                const roi = (1 - (sizes[i] / cumulativeSizes[i])) * changePercents[i];
                dcaRoi.push(roi);
            }

            const cumulativePercent = [];
            
            for (let i = 0; i < n; i++) {
                if (i === 0) {
                    cumulativePercent.push(0);
                } else {
                    const ak = dcaRoi[i] === 0 ? 0 : (changePercents[i] - dcaRoi[i - 1]);
                    cumulativePercent.push(ak);
                }
            }

            const lastAJ = dcaRoi[n - 1];
            const finalAK = stopLoss - lastAJ;
            cumulativePercent.push(finalAK);

            const sumCumulativePercent = cumulativePercent.slice(1).reduce((a, b) => a + b, 0);
            const totalDefense = sumCumulativePercent / leverage;

            const longPrices = [1];
            const longAvgPrices = [1];
            const longCoinCounts = [sizes[0] / 1];
            const longCumulativeCoinCounts = [sizes[0] / 1];
            
            for (let i = 1; i < n; i++) {
                const prevAvgPrice = longAvgPrices[i - 1];
                const newPrice = prevAvgPrice * (100 - (changePercents[i] / leverage)) / 100;
                longPrices.push(newPrice);
                
                const coinCount = sizes[i] / newPrice;
                longCoinCounts.push(coinCount);
                
                const cumulativeCoinCount = longCumulativeCoinCounts[i - 1] + coinCount;
                longCumulativeCoinCounts.push(cumulativeCoinCount);
                
                const avgPrice = cumulativeSizes[i] / cumulativeCoinCount;
                longAvgPrices.push(avgPrice);
            }
            
            const finalLongAvgPrice = longAvgPrices[n - 1];
            const longDefense = (1 - (finalLongAvgPrice * (100 - (stopLoss / leverage)) / 100)) * 100;

            const shortPrices = [1];
            const shortAvgPrices = [1];
            const shortCoinCounts = [sizes[0] / 1];
            const shortCumulativeCoinCounts = [sizes[0] / 1];
            
            for (let i = 1; i < n; i++) {
                const prevAvgPrice = shortAvgPrices[i - 1];
                const newPrice = prevAvgPrice * (100 + (changePercents[i] / leverage)) / 100;
                shortPrices.push(newPrice);
                
                const coinCount = sizes[i] / newPrice;
                shortCoinCounts.push(coinCount);
                
                const cumulativeCoinCount = shortCumulativeCoinCounts[i - 1] + coinCount;
                shortCumulativeCoinCounts.push(cumulativeCoinCount);
                
                const avgPrice = cumulativeSizes[i] / cumulativeCoinCount;
                shortAvgPrices.push(avgPrice);
            }
            
            const finalShortAvgPrice = shortAvgPrices[n - 1];
            const shortDefense = ((finalShortAvgPrice * (100 + (stopLoss / leverage)) / 100) - 1) * 100;

            const totalMargin = cumulativeSizes[n - 1] / leverage;
            const expectedLoss = (totalMargin * stopLoss) / 100;

            return {
                totalDefense,
                longDefense,
                shortDefense,
                expectedLoss
            };
        }

        function handleArrowKeys(event, currentInput) {
            const currentRow = parseInt(currentInput.dataset.row);
            const currentCol = parseInt(currentInput.dataset.col);
            
            let targetRow = currentRow;
            let targetCol = currentCol;
            
            switch(event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    targetRow = currentRow - 1;
                    break;
                case 'ArrowDown':
                case 'Enter':
                    event.preventDefault();
                    targetRow = currentRow + 1;
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    targetCol = currentCol - 1;
                    break;
                case 'ArrowRight':
                case 'Tab':
                    if (event.key === 'Tab') event.preventDefault();
                    targetCol = currentCol + 1;
                    break;
                default:
                    return;
            }
            
            // Constrain column (0: DCA Size, 1: Profit %, 2: Change %)
            if (targetCol < 0) targetCol = 0;
            if (targetCol > 2) targetCol = 2;
            
            // Find target input
            const tbody = document.getElementById('dcaSteps');
            if (targetRow < 0 || targetRow >= tbody.rows.length) return;
            
            const targetRowEl = tbody.rows[targetRow];
            let targetInput = null;
            
            if (targetCol === 0) {
                targetInput = targetRowEl.querySelector('.dca-size');
            } else if (targetCol === 1) {
                targetInput = targetRowEl.querySelector('.dca-profit');
            } else if (targetCol === 2) {
                targetInput = targetRowEl.querySelector('.dca-change');
            }
            
            if (targetInput) {
                targetInput.focus();
                targetInput.select();
            }
        }

        function showTextInput() {
            document.getElementById('textInputModal').style.display = 'flex';
            document.getElementById('logicTextInput').value = '';
        }

        function closeTextInput() {
            document.getElementById('textInputModal').style.display = 'none';
        }

        function applyTextLogic() {
            const text = document.getElementById('logicTextInput').value.trim();
            if (!text) {
                alert('ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const lines = text.split('\n').filter(line => line.trim());
            const tbody = document.getElementById('dcaSteps');
            
            // Remove all rows except step 0
            while (tbody.rows.length > 1) {
                tbody.deleteRow(1);
            }

            // Parse and add new rows
            lines.forEach((line, index) => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length !== 3) {
                    alert(`Ï§Ñ ${index + 1}Ïùò ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. ÌòïÏãù: DCA Size, Profit %, Î≥ÄÎèôÎ•†`);
                    return;
                }

                const size = parseFloat(parts[0]);
                const profit = parseFloat(parts[1]);
                const change = parseFloat(parts[2]);

                if (isNaN(size) || isNaN(profit) || isNaN(change)) {
                    alert(`Ï§Ñ ${index + 1}Ïóê Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïà´ÏûêÍ∞Ä ÏûàÏäµÎãàÎã§.`);
                    return;
                }

                addDcaStepWithValues(size, change, profit, false);
            });

            updateStepNumbers();
            calculateProfitValues();
            closeTextInput();
        }

        window.onload = function() {
            initializeDcaSteps();
            calculate();
            updateScaleButtons();
            
            document.getElementById('leverage').addEventListener('input', calculateProfitValues);
        };
    </script>
</body>
</html>
